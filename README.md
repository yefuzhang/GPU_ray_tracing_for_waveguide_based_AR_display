# GPU Ray Tracing Toolkit for Waveguide-Based AR Displays  
This code was developed by **Yefu Zhang** under the supervision of **Prof. Shin-Tson Wu**.

This repository accompanies our paper on **Fast evaluation of waveguide-based AR displays with an open-source GPU ray-tracing method** (*link to DOI when available*).  
It provides a complete framework for GPU-accelerated optical simulation and performance evaluation of full-color diffractive waveguides.  
The repository includes six main scripts:

| Script | Purpose |
| ------- | -------- |
| `couplers_coor.py` | Generate coupler design parameters and 3-D spatial coordinates for in-, folding-, and out-couplers. |
| `GPU_ray_tracing_functions.py` | Contain all core **CUDA-based GPU kernels** for parallel ray propagation through the waveguide. |
| `AR_system_evaluation_functions.py` | Evaluate system performance: efficiency, color dispersion, FoV uniformity, and eyebox uniformity. |
| `plot_design_fullColor.py` | Visualize the **2-D waveguide layout** and **effective angular response**. |
| `download_lut.py` | Download the **RCWA-based LUT** files required for ray-tracing. |
| `gpu_ray_tracing_pro_fullColor.py` | Run full-color GPU ray tracing and automatically plot all evaluation results. |

---

## 1  `couplers_coor.py`

Generates the structural parameters and coordinates of the couplers.  
All design parametersâ€”periods, positions, and diffraction directionsâ€”are defined here.

| Code region* | Parameter / Function | Description |
| ------------- | ------------------- | ------------ |
| Lines â‰ˆ 40 â€“ 120 | `couplers_coor_full_color()` | Main function to set waveguide geometry and coupler parameters. Edit this section to change your design. |
| Lines â‰ˆ 125 â€“ 200 | `IC`, `FC`, `OC` definitions | Define in-coupler, folding-coupler, and out-coupler positions and orientations. |
| Lines â‰ˆ 210 â€“ 260 | Material and thickness parameters | Set refractive index, waveguide thickness, and substrate geometry. |

\*Line numbers refer to the current version and may shift with edits.

> **Tip:** Modify only the parameters inside `couplers_coor_full_color()` to avoid mismatches with later scripts.

---

## 2  `GPU_ray_tracing_functions.py`

Implements all GPU kernels and host functions using **Numba CUDA** for massive parallel ray tracing.  
Each ray propagates through the waveguide according to LUT-based diffraction data.

| Key functions | Purpose |
| -------------- | -------- |
| `gpu_trace_rays()` | Core GPU kernel performing ray propagation and reflection/refraction tracking. |
| `apply_LUT()` | Retrieves diffraction efficiencies from RCWA LUTs for each coupler and wavelength. |
| `collect_results()` | Aggregates intensity distributions at the eyebox for all FoV angles. |

> Ensure that your CUDA-enabled GPU (e.g., RTX 4080 / A100) is properly configured before running this module.

---

## 3  `AR_system_evaluation_functions.py`

Analyzes the results generated by the GPU ray tracing stage.  
Provides several quantitative metrics for display performance:

| Metric | Description |
| ------- | ----------- |
| **System Efficiency** | Total light throughput from the input pupil to the eyebox. |
| **Color Dispersion** | Wavelength-dependent shift of FoV and brightness. |
| **FoV Uniformity** | Brightness variation across the entire field of view. |
| **Eyebox Uniformity** | Spatial uniformity of brightness perceived by the eye. |

Plots of all metrics are automatically generated after the main simulation.

---

## 4  `plot_design_fullColor.py`

Visualizes the AR waveguide configuration.

| Code region | Parameter | Description |
| ------------ | ---------- | ------------ |
| Lines â‰ˆ 30 â€“ 80 | Design parameters | Imported directly from `couplers_coor_full_color()` |
| Output | 2-D layout + effective angular response | Confirms that couplers are correctly aligned and diffraction directions are valid. |

> **Tip:** Run this script after every major design change to ensure the layout is physically reasonable.

---

## 5  `download_lut.py`

Downloads the full set of **RCWA-generated Look-Up Tables (LUTs)** used in the ray-tracing simulation.  
Each LUT corresponds to a specific coupler and wavelength, containing precomputed diffraction efficiencies and phase information.

| Step | Action |
| ---- | ------- |
| 1 | Execute `python download_lut.py` before running any GPU tracing. |
| 2 | Verify that the downloaded LUTs are stored in the designated `/LUT/` directory. |

> LUT data were generated using RCWA based on the grating structures described in the paper.

---

## 6  `gpu_ray_tracing_pro_fullColor.py`

Main script for running the **full-color GPU ray tracing simulation**.

1. Load LUTs and waveguide parameters.  
2. Launch GPU kernels to trace all rays.  
3. Compute efficiency, uniformity, and color dispersion.  
4. Generate and save plots automatically.

| Code line* | Parameter | Description |
| ----------- | ---------- | ------------ |
| ~45 | `FOVx`, `FOVy`, `lmd_list` | Define the angular and spectral sampling. |
| ~120 | `gpu_batch_size` | Control GPU memory load; decrease if running out of VRAM. |
| ~250 | Output directory | All figures and numerical results will be saved here. |

\*Approximate locations; may shift with updates.

---

## ðŸ§­ Typical Workflow

1. **Download LUTs**
   ```bash
   python download_lut.py
   ```
2. **Set Design Parameters**  
   Edit the function `couplers_coor_full_color()` in `couplers_coor.py`.
3. **Visualize Design**
   ```bash
   python plot_design_fullColor.py
   ```
4. **Run GPU Ray Tracing**
   ```bash
   python gpu_ray_tracing_pro_fullColor.py
   ```
5. **View Results**  
   Efficiency maps, FoV uniformity, eyebox uniformity, and color dispersion plots are saved automatically.

---

## âš™ï¸ Requirements

- Python â‰¥ 3.9  
- **CUDA-enabled GPU** (RTX / A100 or equivalent)  
- Packages:  
  ```bash
  pip install numpy numba matplotlib
  ```

---

## ðŸ“„ Reference

If you use this code in your research, please cite:

> **Y. Zhang, S.-T. Wu**,  
> *â€œFast evaluation of waveguide-based AR displays with an open-source GPU ray-tracing method,â€*  
> [Journal / Conference Name, Year].  

---

*Happy tracing!*  
