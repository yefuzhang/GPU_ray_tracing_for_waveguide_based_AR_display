# GPU Ray Tracing Toolkit for Waveguide-Based AR Displays  
This code was developed by **Yefu Zhang** and **Yuqiang Ding** under the supervision of **Prof. Shin-Tson Wu**.

This repository accompanies our paper on **Fast evaluation of waveguide AR displays with an open-source GPU ray-tracing method** (*link to DOI when available*).  
It provides a complete framework for GPU-accelerated optical simulation and performance evaluation of full-color diffractive waveguides.  
The repository includes six main scripts:

| Script | Purpose |
| ------- | -------- |
| `couplers_coor.py` | Generate coupler design parameters and 3-D spatial coordinates for in-, folding-, and out-couplers. |
| `GPU_ray_tracing_functions.py` | Contain all core **CUDA-based GPU kernels** for parallel ray propagation through the waveguide. |
| `AR_system_evaluation_functions.py` | Evaluate system performance: efficiency, color dispersion, FoV uniformity, and eyebox uniformity. |
| `plot_design_fullColor.py` | Visualize the **2-D waveguide layout** and **effective angular response**. |
| `download_lut.py` | Download the **RCWA-based LUT** files required for ray-tracing. |
| `gpu_ray_tracing_pro_fullColor.py` | Run full-color GPU ray tracing and automatically plot all evaluation results. |

---

## 1  `couplers_coor.py`

Generates the structural parameters and coordinates of the couplers.  
All design parameters‚Äîperiods, positions, and diffraction directions‚Äîare defined here.

| Code region* | Parameter / Function | Description |
| ------------- | ------------------- | ------------ |
| Lines ‚âà 122 ‚Äì 750 | `couplers_coor_full_color()` | Main function to set waveguide geometry and coupler parameters. Edit this section to change your design. |
| Lines ‚âà 125 ‚Äì 127 | `FoV` definitions | Define FoVx and FoVy. |
| Lines ‚âà 136 ‚Äì 140 | Material and thickness parameters | Set refractive index, waveguide thickness, and substrate geometry. |
| Lines ‚âà 158 ‚Äì 164 | Eyebox | Set eyebox size and position. |
| Lines ‚âà 183 ‚Äì 188 | Couplers | Define in-coupler, folding-coupler, and out-coupler grating period and orientations. |

\*Line numbers refer to the current version and may shift with edits.

> **Tip:** Modify only the parameters inside `couplers_coor_full_color()` to avoid mismatches with later scripts.

---

## 2  `GPU_ray_tracing_functions.py`

Implements all GPU kernels and host functions using **Numba CUDA** for massive parallel ray tracing.  
Each ray propagates through the waveguide according to LUT-based diffraction data.

> Ensure that your CUDA-enabled GPU (e.g., RTX 4080 / A100) is properly configured before running this module.

---

## 3  `AR_system_evaluation_functions.py`

Analyzes the results generated by the GPU ray tracing stage.  
Provides several quantitative metrics for display performance:

| Metric | Description |
| ------- | ----------- |
| **System Efficiency** | Total light throughput from the input pupil to the eyebox. |
| **Color Dispersion** | Color difference between pure white and the color after passing through the waveguide. |
| **FoV Uniformity** | Brightness variation across the entire field of view for different eye position. |
| **Eyebox Uniformity** | Spatial uniformity of brightness perceived by the eye. |

---

## 4  `plot_design_fullColor.py`

Visualizes the AR waveguide configuration.

> **Tip:** Run this script after every major design change to ensure the layout is physically reasonable.

---

## 5  `download_lut.py`

Downloads the full set of **RCWA-generated Look-Up Tables (LUTs)** used in the ray-tracing simulation.  
Each LUT corresponds to a specific coupler and wavelength, containing precomputed diffraction efficiencies and phase information.
RCWA code is currently not avaiable.

| Step | Action |
| ---- | ------- |
| 1 | Execute `python download_lut.py` before running any GPU tracing. |
| 2 | Verify that the downloaded LUTs are stored in the designated `/LUT/` directory. |

> ‚ö†Ô∏è **Note:** Sorry, the RCWA generation module is **currently unavailable** in this repository.
> Please use the **pre-computed LUT files** provided for simulation.

---

## 6  `gpu_ray_tracing_pro_fullColor.py`

Main script for running the **full-color GPU ray tracing simulation**.

1. Load LUTs and waveguide parameters.  
2. Launch GPU kernels to trace all rays.  
3. Compute efficiency, uniformity, and color dispersion.  
4. Generate plots automatically.

| Code line* | Parameter | Description |
| ----------- | ---------- | ------------ |
| Lines ‚âà 61 | `num_rays_per_FoV` | Define the number of rays for each FoV and each wavelength. |

\*Approximate locations; may shift with updates.

---

## üß≠ Typical Workflow

1. **Download LUTs**
   ```bash
   python download_lut.py
   ```
2. **Set Design Parameters**  
   Edit the function `couplers_coor_full_color()` in `couplers_coor.py`.
3. **Visualize Design**
   ```bash
   python plot_design_fullColor.py
   ```
4. **Run GPU Ray Tracing**
   ```bash
   python gpu_ray_tracing_pro_fullColor.py
   ```
5. **View Results**  
   Efficiency maps, FoV uniformity, eyebox uniformity, and color dispersion plots are saved automatically.

---

## ‚öôÔ∏è Requirements

- Python ‚â• 3.9  
- **CUDA-enabled GPU** (RTX / A100 or equivalent)  
- Packages:  
  ```bash
  pip install numpy numba matplotlib colour-science cv2 shapely scipy math
  ```

---

*Happy tracing!*  
